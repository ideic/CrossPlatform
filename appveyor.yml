version: 1.0.{build}
image: 
- Visual Studio 2022
- Ubuntu
platform:
- x64
environment:
    matrix:
      - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2022
        VCVAR2022: 'C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat'
      - APPVEYOR_BUILD_WORKER_IMAGE: Ubuntu 
      
before_build:
- ps: |
    # ...example script to set the proper flags for vcvarsall ...
    # syntax: vcvarsall.bat [architecture] [platform_type] [winsdk_version] [-vcvars_ver=vcversion]
    $Architecture = $env:PLATFORM # simplified, works for x86 and x64
    if ("$env:APPVEYOR_BUILD_WORKER_IMAGE" -eq "Visual Studio 2022") {
      $env:VCVARSALL = "`"$env:VCVAR2022`" $Architecture"
    } else {
      $env:VCVARSALL = ""
    }
- call %VCVARSALL%
build_script:
- cmd: >-
    cd RTPApp

    cmake . --preset x64-release

    cd out\build\x64-release

    cmake --build .
test_script:
- cmd: >- 
        NetworkTest\NetworkTest.exe --gtest_output=xml:NetworkTest\testresults.xml
        
        CommonTest\CommonTest.exe --gtest_output=xml:CommonTest\testresults.xml
after_test:
- ps: |
    $wc = New-Object 'System.Net.WebClient'
    $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path NetworkTest\testresults.xml))
    $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path CommonTest\testresults.xml))
notifications:
- provider: Email
  to:
  - ideic75@gmail.com
  on_build_success: true
  on_build_failure: true
  on_build_status_changed: true